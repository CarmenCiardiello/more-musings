---
title: "Score-Effect Remnants"
author: "Carmen Ciardiello"
date: "2024-08-08"
categories: [hockey, analysis]
---

```{r}
#| echo: false
#| include: false
#| warning: false

library(tidyverse)
library(hockeyR)
library(duckplyr)
library(gt)

gt_theme_athletic <- function(gt_object, ...) {
  
  # get id, if one is passed through to use with CSS
  table_id <- subset(gt_object[['_options']], parameter == 'table_id')$value[[1]]
  
  table <- gt_object |> 
    # set table font
    gt::opt_table_font(
      font = list(
        gt::google_font('Spline Sans Mono'),
        gt::default_fonts()
      ),
      weight = 500
    ) |> 
    # set the column label font and style
    gt::tab_style(
      locations = gt::cells_column_labels(
        columns = gt::everything()
      ),
      style = gt::cell_text(
        font = gt::google_font('Work Sans'),
        weight = 650,
        size = px(14),
        transform = 'uppercase', # column labels to uppercase
        align = 'left'
      )
    ) |> 
    gt::tab_style(
      locations = gt::cells_title('title'),
      style = gt::cell_text(
        font = gt::google_font('Work Sans'),
        weight = 650
      )
    ) |> 
    gt::tab_style(
      locations = gt::cells_title('subtitle'),
      style = gt::cell_text(
        font = gt::google_font('Work Sans'),
        weight = 500
      )
    ) |>
    # set think black column sep.
    gt::tab_style(
      style = gt::cell_borders(sides = 'left', weight = px(0.5), color = 'black'),
      locations = gt::cells_body(
        # everything but the first column
        columns = c(-names(gt_object[['_data']])[1])
      )
    ) |> 
    # set thin dotted row sep.
    gt::tab_style(
      style = gt::cell_borders(sides = "top", color = 'black', weight = px(1.5), style = 'dotted'),
      locations = gt::cells_body(
        rows = gt::everything()
      )
    )|>
    # left align cell text
    gt::cols_align(
      align = 'left',
      columns = gt::everything()
    ) |> 
    gt::tab_options(
      table.font.size = 14,
      column_labels.border.bottom.width = 2,
      column_labels.border.bottom.color = 'black',
      column_labels.border.top.color = 'white',
      row_group.border.bottom.color = 'white',
      table.border.top.style = 'none',
      table.border.bottom.style = 'none',
      heading.border.bottom.style = 'none',
      heading.align = 'left',
      heading.title.font.size = px(30),
      source_notes.border.lr.style = 'none',
      source_notes.font.size = 10
    )
  
  # add css if table id is passed through
  table <- if(!is.null(table_id)) {
    table |> 
      # remove the border from the bottom cell
      gt::opt_css(
        paste0("#", table_id, " tbody tr:last-child {border-bottom: 2px solid #ffffff00;}"),
        add = TRUE
      )
  }
  
  return(table)
  
}

```

A playoff game between the Rangers and Hurricanes on May 16th, 2024 sparked a question in regards to score effects. This was the deciding game in the series, a series in which the Rangers prevailed four games to two. At the start of the third period, the Rangers were down three goals to one. Martin Necas opened up the scoring with just 82 seconds left in the first period, followed by goals from Seth Jarvis, Vincent Trocheck, and Sebastian Aho all in first half of the second period. Anecdotally, play was pretty even between both sides despite the two goal deficit and the Rangers really opened it up offensively in the third period as they sought to chase down Carolina (as NHL teams are wont to do). What was curious to me was that even after tying the game, the Rangers appeared to push with the same offensive fervor that they were as they trailed by two goals. 

This curiosity was the result of my basic understanding of what folks call score-effects. For the uninitiated, score-effects are the phenomena of, when controlling for the quality of the teams at hand, hockey clubs push more aggressively offensively when trailing and, correspondingly, cede territory and shots when defending a lead. Naturally this phenomena grows as the score differential grows, the consequence of the marginal value of a goal conceded lessening as the score differential increases. A team trailing by two goals is very likely to lose, as is a team trailing by three goals at any point in time. Thus, the trailing team does not care much for conceding a goal because it was already likely to lose down 2 goals while a goal scored would greatly increase its odds of winning. We often use score-effects to discount shots, chances, or expected goals generated by a team trailing. If teams behave in such a way where there are these measurable score-effects, one can surmise that it is much easier to generate offense when the other team is not much of a threat to return the favor. 

Now, let us get back to the game between New York and Carolina. The Rangers made a large comeback down two goals at the start of the third period but seemingly kept the pedal to metal (as it were) once the game was tied, eventually tacking on the game-winning goal with just under four minutes after the game-tying goal and sealing the contest and playoff series with an empty net goal in the final minute. And (again anecdotally) this did not seem to be a function of the Rangers receiving a visit from Lady Luck and opportunistically scoring on two of only a handful of shots; moreover they continued to dominate play even as and after the score was tied. This brings me to my question: is there such a thing as score-effect remnants? Meaning, when teams are chasing down a large deficit and happen to make a comeback, is there some sort of residual effect where the previously trailing team stays in a similar tactical lane? One might interpret this as a specific aspect or type of "momentum", a (to put it gently) much debated topic in discourse across sports. Some of a certain persuasion might be rolling their eyes, while others might be baffled at the suggestion that momentum is not a driving force in deciding athletic contests. At the risk of angering folks, I thought it would be a worthwhile exercise to investigate the existence of these score-effect residuals and determine if my eyes were playing a trick on me as I took in the come-from-behind Rangers victory.  

I pulled play-by-play data from the 2021 through 2024 seasons. I searched for games where at some point one team in the contest was trailing by at least three goals. I then filtered for those games and in those games found the point where the score differential reached three and only considered the play-by-play data after that point. In these games I identified the trailing team in question and tracked its performance as the game progressed. As a proxy for performance, the metric of choice was 5v5 expected goals for percentage (xGF%) for the trailing team (for those unfamiliar, expected goals takes unblocked shot attempts and weights those shot attempts by the probability that the shot attempt results in a goal, so an xG of 0.1 indicates that the shot has a 10% chance of finding the back of the net). This process yielded the following results: 

```{r}
#| echo: false
#| warning: false

pbp_big <- readRDS("big_lead_pbp.rds")

pbp_big %>% 
  group_by( abs(shoot_team_score_diff) ) %>% 
  summarise(
    n = n(), 
    losing_xg = sum( losing_xg, na.rm = TRUE ), 
    winning_xg = sum( winning_xg, na.rm = TRUE )
    ) %>% 
  ungroup() %>% 
  mutate(
    xg_perc = round( losing_xg / ( losing_xg + winning_xg ) * 100, digits = 1 )
    ) %>% 
  filter( n >= 3000, `abs(shoot_team_score_diff)` != 0 ) %>% 
  rename( score_diff = `abs(shoot_team_score_diff)` ) %>% 
  gt() %>% 
  cols_label(
    score_diff = "Score Diff", 
    losing_xg = "Losing xG", 
    winning_xg = "Winning xG", 
    xg_perc = "xGF%"
  ) %>% 
  fmt_number(
    columns = losing_xg:winning_xg
  ) %>% 
  gt_theme_athletic()

```

The column N indicates the number of entries in the play-by-play for each score differential. I filtered scores where the they did not appear on at least 3000 occasions for readability and sample size concerns. Clubs basically break even when the score differential is at least three and then there is a large dip in performance when they get a goal back. Then, following a second goal that brings the score within one, teams largely are trading chances at an even rate. What can we surmise from these results, especially the atrophy in performance when the deficit is cut by one? I would consider what types of teams dominate this sample of play-by-play events. As you may imagine, more likely than not teams that find themselves trailing by at least three goals are largely, uh, really bad for lack of a more eloquent term. The 2024 Sharks were much more likely to be losing by three goals at any point in a contest compared to the 2024 Panthers. But, good teams are not immune to large deficits over the course of an 82 game regular season. So of the instances where a team is losing by three goals, those teams that bring the deficit back to one are more likely than not good teams that happen to have an off or unlucky night. I will also note with the 34.5% xGF%, that figure is so low that it is probably evidence in and of itself that we are not dealing with a sufficiently large sample to come to any firm conclusions. Even the worst teams should not be expected to perform so poorly against the best teams in any game in any given season on average.  

I would argue this table provides some indication that my pondering of the existance of score-effect residuals was misguided and the result of being swept up in the results of a singular outcome. Teams do not seem to perform better after coming back from a large deficit. Compare the results above to the results regardless of whether one team suffers a large deficit:

```{r}
#| echo: false
#| warning: false

pbp_5v5 <- readRDS("pbp.rds")

pbp_5v5 %>% 
  mutate(
    is_losing = ifelse(shoot_team_score_diff < 0, 1, 0), 
    is_winning = ifelse(shoot_team_score_diff > 0, 1, 0),
    is_tied = ifelse(shoot_team_score_diff == 0, 1, 0),
    losing_xg = ifelse(is_losing == 1, xg, 0), 
    winning_xg = ifelse(is_winning, xg, 0)
  ) %>% 
  group_by( abs(shoot_team_score_diff) ) %>% 
  summarise(
    n = n(), 
    losing_xg = sum( losing_xg, na.rm = TRUE ), 
    winning_xg = sum( winning_xg, na.rm = TRUE )
    ) %>% 
  ungroup() %>% 
  mutate(
    xg_perc = round( losing_xg / ( losing_xg + winning_xg ) * 100, digits = 1 )
    ) %>% 
  filter( n >= 3000, `abs(shoot_team_score_diff)` != 0 ) %>% 
  rename( score_diff = `abs(shoot_team_score_diff)` ) %>% 
  gt() %>% 
  cols_label(
    score_diff = "Score Diff", 
    losing_xg = "Losing xG", 
    winning_xg = "Winning xG", 
    xg_perc = "xGF%"
  ) %>% 
  fmt_number(
    columns = losing_xg:winning_xg
  ) %>% 
  gt_theme_athletic()


```

There is functionally no difference with the larger deficits and when looking at those two and one goal deficits we actually see an improvement, a function of diluting the effects of the worst teams in the league with the performance of the league on the whole. I should also point out that since we have a much larger sample of events to pull from, we do see losing teams have a slight edge no matter the deficit, which is not surprising given the existence of these score-effects. If there were no score-effects, we would not expect the losing team to outperform its leading counterpart because more likely than not in any given game the winning team would be expected to be better in a neutral situation, all else being equal.  

So, unfortunately, it looks like there are no exciting conclusions to draw from my initial inquiry. The score-effects are the score-effects and teams do not seem to be able to buck that phenomenon even with the aid of the excitement associated with a comeback attempt. I guess you can put another tally in the column for the momentum truthers. I welcome any comments or questions about the methodology used in this analysis. It is likely far from perfect and I would imagine there are more rigorous methods to approach this question with. I was just filtering and binning play-by-play data and chose the three goal deficit arbitrarily. Another avenue could be to create a model with a term that serves as a proxy for a comeback with some clever feature engineering and you could look at the significance of the feature(s) that highlight these situations. For now, I will leave that to another intrepid analyst.
